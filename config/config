# echo "fff"
export PLUGIN_PIPELINE_NAME=pipeline

export PLUGIN_PIPELINE_DIR=$ZMICRO_PLUGINS_PATH/pipeline

export PLUGIN_PIPELINE_MOD=$PLUGIN_PIPELINE_DIR/mod
export PLUGIN_PIPELINE_CORE_DIR=$PLUGIN_PIPELINE_DIR/core
export PLUGIN_PIPELINE_CONFIG_DIR=$PLUGIN_PIPELINE_DIR/config

export PLUGIN_PIPELINE_PIPELINES_DIR=$PLUGIN_PIPELINE_DIR/pipelines

export PLUGIN_PIPELINE_COMPOSE_DIR=$PLUGIN_PIPELINE_DIR/config/compose

export PLUGIN_PIPELINE_CONTEXT=${PLUGIN_PIPELINE_CONTEXT:-$PWD}
export PLUGIN_PIPELINE_ENV_FILE=${PLUGIN_PIPELINE_ENV_FILE:-$PLUGIN_PIPELINE_CONTEXT/.env}
export PLUGIN_PIPELINE_NAME=${PLUGIN_PIPELINE_NAME}

export PLUGIN_PIPELINE_NETWORK=${PLUGIN_PIPELINE_NETWORK:-"compose-ingress"}

export PIPELINE_RUNNER_WORKDIR=${PIPELINE_RUNNER_WORKDIR:-$PWD}
export PLUGIN_PIPELINE_RUNNER_ID=${PLUGIN_PIPELINE_RUNNER_ID:-$(os::uuid)}

export DOCKER_COMPOSE=${DOCKER_COMPOSE:-$(which docker-compose)}

export PIPELINE_BUILD_CONTEXT_DEFAULT="/tmp/zmicro_plugin_pipeline/build"
export PLUGIN_PIPELINE_BUILD_CONTEXT=${PIPELINE_BUILD_CONTEXT}
if [ -z "$PLUGIN_PIPELINE_BUILD_CONTEXT" ]; then
  PLUGIN_PIPELINE_BUILD_CONTEXT=${PLUGIN_PIPELINE_BUILD_CONTEXT}
fi

# PLUGIN_PIPELINE_BUILD_CONTEXT must starts with /build
if [ -n "$PLUGIN_PIPELINE_BUILD_CONTEXT" ]; then
  if [ "${PLUGIN_PIPELINE_BUILD_CONTEXT:0:6}" != "/build" ] && [ "${PLUGIN_PIPELINE_BUILD_CONTEXT:0:4}" != "/tmp" ]; then
    log::error "PLUGIN_PIPELINE_BUILD_CONTEXT must starts with /build, such as /build, /build/pipeline, /build/tmp ..."
    exit 1
  fi
fi

if [ "$PLUGIN_PIPELINE_BUILD_CONTEXT" = "" ]; then
  export PLUGIN_PIPELINE_BUILD_CONTEXT=$PIPELINE_BUILD_CONTEXT_DEFAULT
fi

# move to core/env
# # BUILD CONTEXT FILES
# # build log
# export PIPELINE_BUILD_CONTEXT_LOG="$PLUGIN_PIPELINE_BUILD_CONTEXT/log"
# # build status:  running | succeed | failed
# export PIPELINE_BUILD_CONTEXT_STATUS="$PLUGIN_PIPELINE_BUILD_CONTEXT/status"
# # build time
# export PIPELINE_BUILD_CONTEXT_RUNNING_AT="$PLUGIN_PIPELINE_BUILD_CONTEXT/running_at"
# export PIPELINE_BUILD_CONTEXT_SUCCEED_AT="$PLUGIN_PIPELINE_BUILD_CONTEXT/ended_at"
# export PIPELINE_BUILD_CONTEXT_FAILED_AT="$PLUGIN_PIPELINE_BUILD_CONTEXT/failed_at"